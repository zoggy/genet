<!DOCTYPE HTML>
<html>
<head>
<title>Genet : Generating reports with Stog-RDF</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="http://zoggy.github.io/genet/style.css" rel="stylesheet" type="text/css"/>
<rssfeed></rssfeed>
</head><body>
<div id="page">
<div class="navbar navbar-fixed-top">
<div class="navbar-inner">
<div class="container">

  <div class="nav-collapse">
  <ul class="nav">
    <li class="&lt;navbar-home/&gt;"><a href="http://zoggy.github.io/genet">Genet</a></li>
    <li class="&lt;navbar-shots/&gt;"><a href="http://zoggy.github.io/genet/screenshots.html">Screenshots</a></li>
    <li class="&lt;navbar-download/&gt;"><a href="http://zoggy.github.io/genet/download.html">Download</a></li>
    <li class="&lt;navbar-doc/&gt;"><a href="http://zoggy.github.io/genet/doc.html">Documentation</a></li>
    <li class="active"><a href="http://zoggy.github.io/genet/blog.html">Blog</a></li>
    <li class="&lt;navbar-about/&gt;"><a href="http://zoggy.github.io/genet/about.html">?</a></li>
  </ul>
  </div>
  <div class="nav pull-right">

  </div>
</div>
</div>
</div>

<div id="header">

<div class="page-title">Generating reports with Stog-RDF</div>
</div>
<span></span>
<div class="date">September 30, 2013</div>

<p>
Genet stores information in RDF graphs: tools, branches,
versions, interfaces, flatten chains, instanciations, ...
Genet allows to build (part of) continuous integration performs.
Wanting to generate reports is natural. Let's see how to do this
using <span class="ext-a"><a href="http://zoggy.github.io/stog/plugins/rdf.html">Stog-RDF</a></span>.
</p>

<p>
Stog-RDF is a plugin for <span class="ext-a"><a href="http://zoggy.github.io/stog/">Stog</a></span>,
a tool to generate static web sites (it is not only for web sites but
it is what interests us right now). Stog-RDF adds new features to Stog:
ability to define RDF graphs, load existing ones, and run Sparql queries
to extract data while generating the XML documents.
</p>
<p>As an example, we will generate a simple page listing the executions
(chains that were instanciated) of the day, indicating whether each one
succeeded or failed.
</p>
<div class="section"><div class="section-title" id="setup">Setup</div>
<p>
We need to define the Genet database as source of a RDF graph,
which can be used from rules introduced by Stog-RDF.
</p>
<p>To do so, we define the Genet RDF graph as a source in the
<span class="icode">.stog/config-rdf</span> file in our web site source directory:
</p>
<pre class="code-ocaml"><span class="hl com">(* pairs (uri, name) specifying namespaces *)</span>
namespaces <span class="hl opt">=</span>
  <span class="hl opt">[(</span><span class="hl str">&quot;https://raw.github.com/zoggy/genet/master/doc/genet.ttl#&quot;</span><span class="hl opt">,</span> genet<span class="hl opt">)]</span>
<span class="hl com">(* name of main graph output file *)</span>
graph_file <span class="hl opt">=</span> <span class="hl str">&quot;graph.rdf&quot;</span>
<span class="hl com">(* pairs (uri, options) specifying graphs to load and associate to uris.</span>
<span class="hl com">   Options is a list of pair (name, value). To load a load, use [&quot;file&quot;,</span>
<span class="hl com">   &quot;myfile.ttl&quot;]. Other options can be given to access graphs from a database</span>
<span class="hl com">   (see OCaml-RDF's Rdf_graph documentation) *)</span>
sources <span class="hl opt">=</span>
  <span class="hl opt">[(</span><span class="hl str">&quot;http://localhost:8082/&quot;</span><span class="hl opt">,</span>
    <span class="hl opt">[(</span>storage<span class="hl opt">,</span> mysql2<span class="hl opt">); (</span>database<span class="hl opt">,</span> genet_example<span class="hl opt">); (</span>user<span class="hl opt">,</span> genet<span class="hl opt">);</span>
     <span class="hl opt">(</span>host<span class="hl opt">,</span> localhost<span class="hl opt">); (</span>password<span class="hl opt">,</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">); (</span>port<span class="hl opt">,</span> <span class="hl str">&quot;3306&quot;</span><span class="hl opt">)])]</span></pre>
<p>
When Stog is launched with the stog-rdf plugin, this plugin reads this config file
and creates the graphs described in <span class="icode">sources</span>.
</p>
<p>
Here, the Genet graph is named with IRI <span class="icode">http://localhost:8082/&quot;</span>.
Note that we also defined a <span class="icode">genet:</span> namespace to shorten
the IRIs used in the Sparql query.
</p>
<p>
Then we create a simple <span class="icode">index.html</span> file:
</p>
<pre class="code-xml"><span class="hl kwa">&lt;page</span> <span class="hl kwb">title</span>=<span class="hl str">&quot;Genet report&quot;</span>
<span class="hl kwb">main</span>=<span class="hl str">&quot;true&quot;</span>
stog:<span class="hl kwb">site-url</span>=<span class="hl str">&quot;file:///tmp/&quot;</span>
<span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;table</span> <span class="hl kwb">class</span>=<span class="hl str">&quot;table&quot;</span><span class="hl kwa">&gt;</span>
...
<span class="hl kwa">&lt;/table&gt;</span>
<span class="hl kwa">&lt;/page&gt;</span></pre>
<p>The &quot;...&quot; will be replaced by some code to query the Genet graph.</p>
<p>We also create a template file for &quot;page&quot; elements, in <span class="icode">.stog/templates/page.tmpl</span>:</p>
<pre class="code-xml"><span class="hl kwa">&lt;html&gt;</span>
    <span class="hl kwa">&lt;head&gt;</span>
      <span class="hl kwa">&lt;title&gt;&lt;site-title/&gt;</span> : <span class="hl kwa">&lt;elt-title/&gt;&lt;/title&gt;</span>
      <span class="hl kwa">&lt;meta</span> <span class="hl kwb">http-equiv</span>=<span class="hl str">&quot;Content-Type&quot;</span> <span class="hl kwb">content</span>=<span class="hl str">&quot;text/html; charset=utf-8&quot;</span><span class="hl kwa">/&gt;</span>
      <span class="hl kwa">&lt;link</span> <span class="hl kwb">rel</span>=<span class="hl str">&quot;stylesheet&quot;</span> <span class="hl kwb">type</span>=<span class="hl str">&quot;text/css&quot;</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;&amp;lt;site-url/&amp;gt;/style.css&quot;</span><span class="hl kwa">&gt;&lt;/link&gt;</span>

    <span class="hl kwa">&lt;/head&gt;</span>
    <span class="hl kwa">&lt;body&gt;</span>
      <span class="hl kwa">&lt;div</span> <span class="hl kwb">id</span>=<span class="hl str">&quot;page&quot;</span><span class="hl kwa">&gt;</span>
      <span class="hl kwa">&lt;div</span> <span class="hl kwb">class</span>=<span class="hl str">&quot;page-title&quot;</span><span class="hl kwa">&gt;&lt;elt-title/&gt;&lt;/div&gt;</span>
      <span class="hl kwa">&lt;elt-body/&gt;</span>
      <span class="hl kwa">&lt;/div&gt;</span>
    <span class="hl kwa">&lt;/body&gt;</span>
  <span class="hl kwa">&lt;/html&gt;</span></pre>
</div>

<div class="section"><div class="section-title" id="query">The Sparql query</div>
<p>
The Sparql query to get the instanciations can be written as:
</p>
<pre class="code-sql"><span class="hl kwa">PREFIX</span> genet<span class="hl opt">: &lt;</span>https<span class="hl opt">://</span><span class="hl kwb">raw</span>.github.com<span class="hl opt">/</span>zoggy<span class="hl opt">/</span>genet<span class="hl opt">/</span>master<span class="hl opt">/</span>doc<span class="hl opt">/</span>genet.ttl#<span class="hl opt">&gt;</span>
<span class="hl kwa">PREFIX</span> rdf<span class="hl opt">: &lt;</span>http<span class="hl opt">://</span>www.w3.org<span class="hl opt">/</span><span class="hl num">1999</span><span class="hl opt">/</span><span class="hl num">02</span><span class="hl opt">/</span><span class="hl num">22</span><span class="hl opt">-</span>rdf<span class="hl opt">-</span>syntax<span class="hl opt">-</span>ns#<span class="hl opt">&gt;</span>

<span class="hl kwa">SELECT</span> ?ichain ?<span class="hl kwb">date</span> ?instnode
<span class="hl kwa">FROM</span> <span class="hl opt">&lt;</span>http<span class="hl opt">://</span>localhost<span class="hl kwc">:8082</span><span class="hl opt">/&gt;</span>
<span class="hl kwa">WHERE</span> <span class="hl opt">{</span> ?ichain a genet<span class="hl kwc">:Instchain</span> .
        ?ichain genet<span class="hl kwc">:stoppedOn</span> ?<span class="hl kwb">date</span> .
        OPTIONAL <span class="hl opt">{</span> ?ichain genet<span class="hl kwc">:failedCommand</span> ?instnode <span class="hl opt">}</span> .
        <span class="hl kwa">FILTER</span> <span class="hl opt">(</span><span class="hl kwa">YEAR</span><span class="hl opt">(</span>?<span class="hl kwb">date</span><span class="hl opt">)=</span><span class="hl kwa">YEAR</span><span class="hl opt">(</span><span class="hl kwd">NOW</span><span class="hl opt">()) &amp;&amp;</span> <span class="hl kwa">MONTH</span><span class="hl opt">(</span>?<span class="hl kwb">date</span><span class="hl opt">)=</span><span class="hl kwa">MONTH</span><span class="hl opt">(</span><span class="hl kwd">NOW</span><span class="hl opt">()) &amp;&amp;</span> <span class="hl kwa">DAY</span><span class="hl opt">(</span>?<span class="hl kwb">date</span><span class="hl opt">)=</span><span class="hl kwa">DAY</span><span class="hl opt">(</span><span class="hl kwd">NOW</span><span class="hl opt">()))</span>
      <span class="hl opt">}</span></pre>
<p>The query is quite simple: we look for all instanciations (<span class="icode">?ichain</span>)
with their end date (<span class="icode">?date</span>),
and, in case of error, the optional node (<span class="icode">?instnode</span>)
corresponding to the command which failed.
We filter the result to keep only the instanciations which ended on the current day.
</p>
<p class="alert alert-warning">
The structure of the RDF graph used by Genet is not documented yet.
</p>
<p>
The <span class="icode">FROM</span> clause refers to the graph in our Genet database.
Now let's use this query.
</p>
</div>

<div class="section"><div class="section-title" id="using">Using the query</div>
<p>
To evaluate this query and insert the result in our <span class="icode">index.html</span> page,
we use the <span class="icode"><span class="hl kwa">&lt;rdf-select&gt;</span></span> rule of Stog-RDF. We replace the &quot;...&quot; by the
following code:
</p>
<pre class="code-xml"><span class="hl kwa">&lt;rdf-select</span> <span class="hl kwb">tmpl</span>=<span class="hl str">&quot;instchain.tmpl&quot;</span><span class="hl kwa">&gt;</span>&lt;![CDATA[
  SELECT ?ichain ?date ?instnode
  FROM <span class="hl kwa">&lt;http:</span>//localhost:<span class="hl num">8082</span><span class="hl kwa">/&gt;</span>
  WHERE { ?ichain a genet:Instchain .
          ?ichain genet:stoppedOn ?date .
          OPTIONAL { ?ichain genet:failedCommand ?instnode } .
          FILTER (YEAR(?date)=YEAR(NOW()) &amp;&amp; MONTH(?date)=MONTH(NOW()) &amp;&amp; DAY(?date)=DAY(NOW()))
        }]]<span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;/rdf-select&gt;</span></pre>
<p>
In the query, we do not need to use the <span class="icode">PREFIX</span> statements, as they are automatically
added by Stog-RDF: <span class="icode">rdf:</span> is always added, and <span class="icode">genet:</span> is added
from its definition in <span class="icode">.stog/config-rdf</span>.
</p>
<p>
The query is evaluated when the <span class="icode"><span class="hl kwa">&lt;rdf-select&gt;</span></span> is handled. For each solution
of the SELECT query, the template file indicated by the <span class="icode">tmpl</span> attribute is used
to create XML code. (See <span class="ext-a"><a href="http://zoggy.github.io/stog/plugins/rdf.html#querying">details here</a></span>).
</p>
<p>
Here, the content of <span class="icode">.stog/templates/instchain.tmpl</span> is the following:
</p>
<pre class="code-xml"><span class="hl kwa">&lt;tr&gt;</span>
  <span class="hl kwa">&lt;td&gt;&lt;a</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;&amp;lt;ichain/&amp;gt;&quot;</span><span class="hl kwa">&gt;&lt;ichain/&gt;&lt;/a&gt;</span>
  <span class="hl kwa">&lt;if</span> <span class="hl kwb">instnode</span>=<span class="hl str">&quot;&quot;</span><span class="hl kwa">&gt;&lt;dummy_/&gt;&lt;span&gt;</span>Failed on <span class="hl kwa">&lt;a</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;&amp;lt;instnode/&amp;gt;&quot;</span><span class="hl kwa">&gt;&lt;instnode/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/if&gt;</span>
  <span class="hl kwa">&lt;div</span> <span class="hl kwb">class</span>=<span class="hl str">&quot;date&quot;</span><span class="hl kwa">&gt;&lt;date/&gt;&lt;/div&gt;&lt;/td&gt;</span>
  <span class="hl kwa">&lt;td&gt;&lt;if</span> <span class="hl kwb">instnode</span>=<span class="hl str">&quot;&quot;</span><span class="hl kwa">&gt;</span>
     <span class="hl kwa">&lt;span</span> <span class="hl kwb">class</span>=<span class="hl str">&quot;alert alert-success&quot;</span><span class="hl kwa">&gt;</span>OK<span class="hl kwa">&lt;/span&gt;</span>
     <span class="hl kwa">&lt;span</span> <span class="hl kwb">class</span>=<span class="hl str">&quot;alert alert-error&quot;</span><span class="hl kwa">&gt;</span>KO<span class="hl kwa">&lt;/span&gt;</span>
  <span class="hl kwa">&lt;/if&gt;</span>
  <span class="hl kwa">&lt;/td&gt;</span>
<span class="hl kwa">&lt;/tr&gt;</span></pre>
<p>
For each solution, a row (<span class="icode"><span class="hl kwa">&lt;tr&gt;</span></span>) is created and inserted, with some
information from the solution: the instanciation chain with <span class="icode"><span class="hl kwa">&lt;ichain/&gt;</span></span>,
the date with <span class="icode"><span class="hl kwa">&lt;date/&gt;</span></span>. The style and the content of the second column
(success or error) depends whether
<span class="icode"><span class="hl kwa">&lt;instnode/&gt;</span></span> is empty or not, as it was an optional field of each solution.
</p>
<p>
Stog is launched the following way, in the web site source directory. The first command
creates a Stog executable embedding the Stog-rdf plugin and the MySQL backend of
OCaml-RDF. The second command launches this executable to generate the web page in <span class="icode">/tmp</span>:
</p>
<pre class="code-sh"><span class="hl opt">&gt;</span> mk<span class="hl opt">-</span>stog <span class="hl opt">-</span>package stog<span class="hl opt">-</span>rdf<span class="hl opt">,</span>rdf.mysql <span class="hl opt">-</span>o .<span class="hl opt">/</span>stog
<span class="hl opt">&gt;</span> .<span class="hl opt">/</span>stog <span class="hl opt">-</span>d <span class="hl opt">/</span>tmp .</pre>
<p>
The result is shown on the figure below:
</p>
<a href="report_example.png"><div class="img"><img alt="Report example" class="img" src="report_example.png" title="Click to enlarge" width="240"/></div></a>
</div>
<div class="section"><div class="section-title" id="further">Going further</div>
<p>
This is a simple example using Stog-RDF. More complex queries can be used.
</p>
<p>
Since Genet installation includes <a href="http://zoggy.github.io/genet/refdoc/index.html">Genet libraries</a>,
one can also develop a program to generate
report, or <span class="ext-a"><a href="http://zoggy.github.io/stog/writing_plugins.html">develog a Stog plugin</a></span>
providing new rules to generate reports.
</p>
</div>


<div class="comments">
<div>
<div class="elt-keywords">
  <div class="bloc-keywords">
  Topics: <div class="keywords"><a href="http://zoggy.github.io/genet/topic_code.html"><span itemprop="keywords">code</span></a></div>
  </div>
  <div class="bloc-keywords">
  Keywords: <div class="keywords"><a href="http://zoggy.github.io/genet/kw_report.html"><span itemprop="keywords">report</span></a>,<a href="http://zoggy.github.io/genet/kw_rdf.html"><span itemprop="keywords">rdf</span></a>,<a href="http://zoggy.github.io/genet/kw_sparql.html"><span itemprop="keywords">sparql</span></a>,<a href="http://zoggy.github.io/genet/kw_stog-rdf.html"><span itemprop="keywords">stog-rdf</span></a></div>
  </div>
</div>
</div>
<div class="section" itemprop="articleSection">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'genet'; // required: replace example with your forum shortname
      var disqus_url = 'http://zoggy.github.io/genet/posts/report-with-stog-rdf.html' ;
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>
</div>
</div>

<footer id="bottombar">
</footer>
<script src="http://zoggy.github.io/genet/jquery.js" type="text/javascript">_</script>
<script src="http://zoggy.github.io/genet/bootstrap-collapse.js" type="text/javascript">_</script>

</body>
</html>